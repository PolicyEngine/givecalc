name: Health check

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        endpoint:
          - https://policyengine--givecalc-fastapi-app.modal.run/api/health
    steps:
      - name: Check ${{ matrix.endpoint }}
        id: health
        run: |
          STATUS=$(curl -s -o response.json -w "%{http_code}" \
            --max-time 30 "${{ matrix.endpoint }}")
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          echo "HTTP $STATUS"
          cat response.json 2>/dev/null || true
          if [ "$STATUS" != "200" ]; then
            echo "endpoint=${{ matrix.endpoint }}" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const endpoint = "${{ matrix.endpoint }}";
            const status = "${{ steps.health.outputs.status }}";
            const title = `API health check failing: ${endpoint}`;

            // Check for existing open issue with same title
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "health-check",
            });

            const existing = issues.data.find(i => i.title === title);
            if (existing) {
              console.log(`Issue #${existing.number} already open, skipping`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: [
                `The health check for \`${endpoint}\` is failing.`,
                "",
                `- **HTTP status**: ${status}`,
                `- **Workflow run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                `- **Time**: ${new Date().toISOString()}`,
                "",
                "Please investigate and resolve the issue.",
              ].join("\n"),
              labels: ["health-check"],
            });
